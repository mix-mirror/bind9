variables:
  # Not normally needed, but may be if some script uses `apt-get install`.
  DEBIAN_FRONTEND: noninteractive
  # Locale settings do not affect the build, but might affect tests.
  LC_ALL: C

  # enable junk filling via jemalloc option
  MALLOC_CONF: "junk:true"

  # automated commits will inherit identification from pipeline trigger
  GIT_AUTHOR_NAME: "$GITLAB_USER_NAME (GitLab job $CI_JOB_ID)"
  GIT_AUTHOR_EMAIL: "$GITLAB_USER_EMAIL"
  GIT_COMMITTER_NAME: "$GIT_AUTHOR_NAME"
  GIT_COMMITTER_EMAIL: "$GIT_AUTHOR_EMAIL"

  CI_REGISTRY_IMAGE: registry.gitlab.isc.org/isc-projects/images/bind9
  CCACHE_DIR: "/ccache"

  GIT_DEPTH: 1
  GIT_CLEAN_FLAGS: -ffdxq

  # The following values may be overwritten in GitLab's CI/CD Variables Settings.
  BUILD_PARALLEL_JOBS: 6
  TEST_PARALLEL_JOBS: 4

  CLANG_VERSION: 21
  CLANG: "clang-${CLANG_VERSION}"
  SCAN_BUILD: "scan-build-${CLANG_VERSION}"
  LLVM_SYMBOLIZER: "/usr/lib/llvm-${CLANG_VERSION}/bin/llvm-symbolizer"
  CLANG_FORMAT: "clang-format-${CLANG_VERSION}"

  CFLAGS_COMMON: -fno-omit-frame-pointer -fno-optimize-sibling-calls

  UBASAN_CONFIGURE_FLAGS_COMMON: "-Db_sanitize=address,undefined -Didn=enabled -Djemalloc=disabled -Dtracing=disabled"
  TSAN_CONFIGURE_FLAGS_COMMON: "-Db_sanitize=thread -Doptimization=2 -Ddebug=true -Didn=enabled -Dlocktype=system -Djemalloc=disabled --pkg-config-path /opt/tsan/lib/pkgconfig"

  # Pass run-time flags to AddressSanitizer to get core dumps on error.
  ASAN_OPTIONS: abort_on_error=1:disable_coredump=0:unmap_shadow_on_exit=1:detect_odr_violation=0
  ASAN_SYMBOLIZER_PATH: "${LLVM_SYMBOLIZER}"

  TSAN_OPTIONS_COMMON: "disable_coredump=0 second_deadlock_stack=1 atexit_sleep_ms=1000 history_size=7 log_exe_name=true log_path=tsan"
  TSAN_SUPPRESSIONS: "suppressions=${CI_PROJECT_DIR}/.tsan-suppress"
  TSAN_OPTIONS_DEBIAN: "${TSAN_OPTIONS_COMMON} ${TSAN_SUPPRESSIONS} external_symbolizer_path=${LLVM_SYMBOLIZER}"
  TSAN_OPTIONS_FEDORA: "${TSAN_OPTIONS_COMMON} ${TSAN_SUPPRESSIONS} external_symbolizer_path=/usr/bin/llvm-symbolizer"

  UBSAN_OPTIONS: "halt_on_error=1:abort_on_error=1:disable_coredump=0"

  WITHOUT_LIBEDIT: "-Dline=disabled"
  WITH_LIBEDIT: "-Dline=enabled"

  STRESS_CONFIGURE_FLAGS: "-Doptimization=g -Dcmocka=disabled"

  INSTALL_PATH: "${CI_PROJECT_DIR}/.local"

  # In multithreaded unit tests, abort on the first failure
  CMOCKA_TEST_ABORT: 1

  # Disable pytest's "cacheprovider" plugin to prevent it from creating
  # cross-testrun files as there is no need to use that feature in CI.
  PYTEST_ADDOPTS: "-p no:cacheprovider"

  HYPOTHESIS_PROFILE: "ci"

  # Some jobs may clean up the build artifacts unless this is set to 0.
  CLEAN_BUILD_ARTIFACTS_ON_SUCCESS: 1

  # DNS Shotgun performance testing defaults
  SHOTGUN_ROUNDS: 1
  SHOTGUN_DURATION: 120
  # allow unlimited improvements against baseline
  SHOTGUN_EVAL_THRESHOLD_CPU_MIN: '-inf'
  SHOTGUN_EVAL_THRESHOLD_MEMORY_MIN: '-inf'
  SHOTGUN_EVAL_THRESHOLD_RCODE_MAX: '+inf'
  SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_MIN: '-inf'
  SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_DRIFT_MIN: '-inf'

  # Even though there's only one job per runtime environment, the GitLab
  # "instance" executor insists on cloning the Git repository to a path that
  # contains a variable number from zero to the "maximum concurrent instances
  # count" allowed on the GitLab Runner. See the "0" directory in this example
  # path: /home/ec2-user/builds/t1_4FZzvz/0/isc-projects/bind9/.git/.
  #
  # This is not a problem for isolated jobs like "stress" tests that depend on
  # no other jobs. However, it is a problem for jobs that need other jobs'
  # artifacts. For example, a system test job that has its Git repo cloned to
  # the "/1/" sub-path will fail if it downloads build job artifacts that have
  # ./configure output files with "/0/" in its sub-path recorded.
  GIT_CLONE_PATH_INSTANCE_EXECUTOR: "/home/ec2-user/builds/${CI_PROJECT_PATH}/"

default:
  # Allow all running CI jobs to be automatically canceled when a new
  # version of a branch is pushed.
  #
  # See: https://docs.gitlab.com/ee/ci/pipelines/settings.html#auto-cancel-redundant-pipelines
  interruptible: true

  # AWS can interrupt the spot instance anytime, so let's retry the job when
  # the interruption event happens to avoid a pipeline failure.
  retry:
    max: 2
    when:
      - runner_system_failure

stages:
  - precheck
  - build
  - unit
  - system
  - performance
  - docs
  - postcheck
  - postmerge
  - release

### Runner Tag Templates

# AlmaLinux autoscaling GitLab Runners on AWS EC2 (amd64)

.almalinux-8fips-amd64-image: &almalinux_8fips_amd64_image
  tags:
    - almalinux-8
    - amd64
    - autoscaler
    - aws
    - fips
    - shell

.almalinux-9fips-amd64-image: &almalinux_9fips_amd64_image
  tags:
    - almalinux-9
    - amd64
    - autoscaler
    - aws
    - fips
    - shell

.almalinux-10fips-amd64-image: &almalinux_10fips_amd64_image
  tags:
    - almalinux-10
    - amd64
    - autoscaler
    - aws
    - fips
    - shell

# Autoscaling GitLab Runner on AWS EC2 (amd64)

.linux-amd64: &linux_amd64
  tags:
    - linux
    - aws
    - runner-manager
    - amd64

# Autoscaling GitLab Runner on AWS EC2 (arm64)

.linux-arm64: &linux_arm64
  tags:
    - linux
    - aws
    - runner-manager
    - aarch64

.freebsd-autoscaler-13-amd64-tags: &freebsd_autoscaler_13_amd64_tags
  tags:
    - amd64
    - autoscaler
    - aws
    - bsd-stress-test-1
    - shell
    - stress-test

.freebsd-autoscaler-14-amd64-tags: &freebsd_autoscaler_14_amd64_tags
  tags:
    - amd64
    - autoscaler
    - aws
    - bsd-stress-test-2
    - shell
    - stress-test

.freebsd-autoscaler-amd64: &freebsd_autoscaler_amd64
  variables:
    CC: clang
    CFLAGS: "${CFLAGS_COMMON}"
    GIT_CLONE_PATH: "${GIT_CLONE_PATH_INSTANCE_EXECUTOR}"
    # Use MIT Kerberos5 for BIND 9 GSS-API support because of FreeBSD Heimdal
    # incompatibility; see https://bugs.freebsd.org/275241.
    EXTRA_CONFIGURE: "${WITH_LIBEDIT} -Doptimization=g --native-file ci/freebsd.ini"

# Autoscaling GitLab Runner on AWS EC2 (FreeBSD 13)

.freebsd-autoscaler-13-amd64: &freebsd_autoscaler_13_amd64
  <<: *freebsd_autoscaler_amd64
  <<: *freebsd_autoscaler_13_amd64_tags

# Autoscaling GitLab Runner on AWS EC2 (FreeBSD 14)

.freebsd-autoscaler-14-amd64: &freebsd_autoscaler_14_amd64
  <<: *freebsd_autoscaler_amd64
  <<: *freebsd_autoscaler_14_amd64_tags

### Docker Image Templates

# Alpine Linux

.alpine-3.23-amd64: &alpine_3_23_amd64_image
  image: "$CI_REGISTRY_IMAGE:alpine-3.23-amd64"
  <<: *linux_amd64

# AlmaLinux

.almalinux-8-amd64: &almalinux_8_amd64_image
  image: "$CI_REGISTRY_IMAGE:almalinux-8-amd64"
  <<: *linux_amd64

.almalinux-9-amd64: &almalinux_9_amd64_image
  image: "$CI_REGISTRY_IMAGE:almalinux-9-amd64"
  <<: *linux_amd64

.almalinux-10-amd64: &almalinux_10_amd64_image
  image: "$CI_REGISTRY_IMAGE:almalinux-10-amd64"
  <<: *linux_amd64

# Debian

.debian-bookworm-amd64: &debian_bookworm_amd64_image
  image: "$CI_REGISTRY_IMAGE:debian-bookworm-amd64"
  <<: *linux_amd64

.debian-trixie-amd64: &debian_trixie_amd64_image
  image: "$CI_REGISTRY_IMAGE:debian-trixie-amd64"
  <<: *linux_amd64

.tsan-debian-trixie-amd64: &tsan_debian_trixie_amd64_image
  image: "$CI_REGISTRY_IMAGE:tsan-debian-trixie-amd64"
  <<: *linux_amd64

.debian-trixie-amd64cross32: &debian_trixie_amd64cross32_image
  image: "$CI_REGISTRY_IMAGE:debian-trixie-amd64cross32"
  <<: *linux_amd64

.debian-sid-amd64: &debian_sid_amd64_image
  image: "$CI_REGISTRY_IMAGE:debian-sid-amd64"
  <<: *linux_amd64

# openSUSE Tumbleweed

.tumbleweed-latest-amd64: &tumbleweed_latest_amd64_image
  image: "$CI_REGISTRY_IMAGE:tumbleweed-latest-amd64"
  <<: *linux_amd64

# Fedora

.tsan-fedora-43-amd64: &tsan_fedora_43_amd64_image
  image: "$CI_REGISTRY_IMAGE:tsan-fedora-43-amd64"
  <<: *linux_amd64

.fedora-43-amd64: &fedora_43_amd64_image
  image: "$CI_REGISTRY_IMAGE:fedora-43-amd64"
  <<: *linux_amd64

.fedora-43-arm64: &fedora_43_arm64_image
  image: "$CI_REGISTRY_IMAGE:fedora-43-arm64"
  <<: *linux_arm64

# Ubuntu

.ubuntu-jammy-amd64: &ubuntu_jammy_amd64_image
  image: "$CI_REGISTRY_IMAGE:ubuntu-jammy-amd64"
  <<: *linux_amd64

.ubuntu-noble-amd64: &ubuntu_noble_amd64_image
  image: "$CI_REGISTRY_IMAGE:ubuntu-noble-amd64"
  <<: *linux_amd64

# Base image
# This is a meta image that is used as a base for non-specific jobs

.base: &base_image
  <<: *debian_trixie_amd64_image

### Job Templates

.rule_mr_code: &rule_mr_code
  - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    changes:
      - '**/*.c'
      - '**/*.h'
      - '**/meson.build'

.rule_mr_shell: &rule_mr_shell
  - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    changes:
      - '**/*.sh'
      - '**/*.sh.in'
      - 'bin/tests/system/org.isc.bind.system'

.rule_mr_python: &rule_mr_python
  - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    changes:
      - '**/*.py'

.rule_mr_system_tests: &rule_mr_system_tests
  - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    changes:
      - 'bin/tests/system/**/*'

.rule_mr_manual: &rule_mr_manual
  - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    when: manual  # only run on MR if requested
    allow_failure: true  # don't block the pipeline or the pipeline result

.rule_tag: &rule_tag
  - if: '$CI_PROJECT_NAMESPACE == "isc-private" && $CI_COMMIT_TAG != null'

.rule_tag_open_source: &rule_tag_open_source
  - if: '$CI_PROJECT_NAMESPACE == "isc-private" && $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /-S/'

.rule_tag_security: &rule_tag_security
  - if: '$CI_PROJECT_NAMESPACE == "isc-private" && $CI_COMMIT_TAG != null && $RELEASE_TYPE == "security"'

.rule_tag_security_or_subscription: &rule_tag_security_or_subscription
  - if: '$CI_PROJECT_NAMESPACE == "isc-private" && $CI_COMMIT_TAG != null && ($RELEASE_TYPE == "security" || $CI_COMMIT_TAG =~ /-S/)'

.rule_source_other_than_mr: &rule_source_other_than_mr
  - if: '$CI_PIPELINE_SOURCE =~ /^(api|pipeline|schedule|trigger|web)$/ && $REBASE_ONLY != "1"'

.rule_source_all: &rule_source_all
  - if: '$CI_PIPELINE_SOURCE =~ /^(api|merge_request_event|pipeline|schedule|trigger|web)$/ && $REBASE_ONLY != "1"'

.api-pipelines-schedules-tags-triggers-web-triggering-rules: &api_pipelines_schedules_tags_triggers_web_triggering_rules
  rules:
    - *rule_tag
    - *rule_source_other_than_mr

.default-triggering-rules_list: &default_triggering_rules_list
  - *rule_tag
  - *rule_source_all

.default-triggering-rules: &default_triggering_rules
  rules:
    - *default_triggering_rules_list

.code-triggering-rules: &code_triggering_rules
  rules:
    - *rule_mr_code
    - *rule_mr_manual
    - *rule_tag
    - *rule_source_other_than_mr

.shell-triggering-rules: &shell_triggering_rules
  rules:
    - *rule_mr_shell
    - *rule_mr_manual
    - *rule_tag
    - *rule_source_other_than_mr

.python-triggering-rules: &python_triggering_rules
  rules:
    - *rule_mr_python
    - *rule_mr_manual
    - *rule_tag
    - *rule_source_other_than_mr

.extra-system-tests-triggering-rules: &extra_system_tests_triggering_rules
  rules:
    - *rule_tag
    - *rule_source_other_than_mr
    - *rule_mr_system_tests

.precheck: &precheck_job
  <<: *default_triggering_rules
  <<: *base_image
  stage: precheck

.configure: &configure
    - meson setup
      --libdir=lib
      -Dcmocka=enabled
      -Ddeveloper=enabled
      -Dleak-detection=enabled
      -Doptimization=1
      -Dnamed-lto=thin
      $EXTRA_CONFIGURE
      build

# change directory to the workspace before including this
.find_python: &find_python
  - PYTHON="$(cat build/bin/tests/system/isctest/vars/.build_vars/PYTHON)"
  - test -x "$PYTHON"

.find_pytest: &find_pytest
  - PYTEST="$(cat build/bin/tests/system/isctest/vars/.build_vars/PYTEST)"
  - test -x "$PYTEST"

.parse_tsan: &parse_tsan
    - *find_python
    - find -name 'tsan.*' -exec "$PYTHON" util/parse_tsan.py {} \;

.check_readline_setup: &check_readline_setup
    - if [[ -n "${WITHOUT_LIBEDIT}" ]]; then
        ! grep "^#define HAVE_LIBEDIT" build/config.h;
      elif [[ -n "${WITH_LIBEDIT}" ]]; then
        grep -e "^#define HAVE_LIBEDIT" build/config.h;
      fi

.list_installed_package_versions: &list_installed_package_versions
  - echo -e "\e[0Ksection_start:`date +%s`:installed_packages_section[collapsed=true]\r\e[0KHeader of the installed packages collapsible section"
  - ( pip3 list || pip list || echo "no pip" ) 2>/dev/null
  - for cmd in "apk info --verbose" "dpkg-query --show --showformat='\${Package}-\${Version}\n'" "pkg info --quiet" "rpm -qa | sort"; do
      eval "$cmd" 2>/dev/null && break;
    done || true
  - echo -e "\e[0Ksection_end:`date +%s`:installed_packages_section\r\e[0K"

# Unpack release tarball and continue work in the extracted directory.
.unpack_release_tarball: &unpack_release_tarball
  - tar --extract --file build/meson-dist/bind-*.tar.xz
  - rm -f build/meson-dist/bind-*.tar.xz
  - cd bind-*

.fips-feature-test: &fips_feature_test
    - if build/feature-test --have-fips-mode; then
        if [ "$(cat /proc/sys/crypto/fips_enabled)" = "1" ]; then
          echo "FIPS is enabled";
        else
          echo "FIPS is disabled";
          exit 1;
        fi
      fi

.check_for_junit_xml: &check_for_junit_xml
    # test if junit.xml file exists and is longer 40 bytes
    # (i.e., contains more than `<testsuites><testsuite /></testsuites>`)
    - if [ -f "$CI_PROJECT_DIR"/junit.xml ]; then
        if [ $(wc -c < "$CI_PROJECT_DIR"/junit.xml) -gt 40 ]; then
          echo "junit.xml file exists and is longer than 40 bytes.";
        else
          echo "junit.xml file exists but is too short.";
          exit 1;
        fi
      else
        echo "junit.xml file does not exist.";
        exit 1;
      fi

.build: &build_job
  <<: *default_triggering_rules
  stage: build
  before_script:
    - test -w "${CCACHE_DIR}" && export PATH="/usr/lib/ccache:${PATH}"
    - *list_installed_package_versions
  script:
    - *configure
    - *check_readline_setup
    - meson compile -C build
    - meson compile -C build system-test-dependencies
    - ninja -C build meson-test-prereq
    - test -z "${RUN_MESON_INSTALL}" || meson install -C build --destdir=$INSTALL_PATH
    - test -z "${RUN_MESON_INSTALL}" || DESTDIR="${INSTALL_PATH}" sh build/util/check-make-install.sh
    #- test -z "${CROSS_COMPILATION}" || grep -F -A 1 "checking whether we are cross compiling" config.log | grep -q "result.*yes"
    - test -z "${CROSS_COMPILATION}" || file build/lib/dns/gen | grep -F -q "ELF 64-bit LSB"
    #- test -z "${CROSS_COMPILATION}" || ( ! git ls-files -z --others --exclude lib/dns/gen | xargs -0 file | grep "ELF 64-bit LSB" )
    - build/named -V
    - *fips_feature_test
  needs: []
  artifacts:
    untracked: true
    when: always

.setup_interfaces: &setup_interfaces
    - if [ "$(id -u)" -eq "0" ]; then
        sh -x build/bin/tests/system/ifconfig.sh up;
      else
        sudo sh -x build/bin/tests/system/ifconfig.sh up;
      fi

.display_pytest_failures: &display_pytest_failures
    - awk '/^=+ FAILURES =+/{flag=1;next}/^=+.*=+$/{flag=0}flag' bin/tests/system/pytest.out.txt || true
    - awk '/^=+ ERRORS =+/{flag=1;next}/^=+.*=+$/{flag=0}flag' bin/tests/system/pytest.out.txt || true

.shotgun: &shotgun_job
  <<: *base_image
  stage: performance
  rules:  # FIXME disabled shotgun jobs temporarily due to infra issue
    # - if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
    #   changes:
    #     - '**/*.c'
    #     - '**/*.h'
    #   variables:
    #     BASELINE: '$CI_MERGE_REQUEST_DIFF_BASE_SHA'
    - &shotgun_rule_mr_manual
      if: '$CI_MERGE_REQUEST_DIFF_BASE_SHA != null'
      variables:
        BASELINE: '$CI_MERGE_REQUEST_DIFF_BASE_SHA'
      when: manual  # don't run on each MR unless requested
      allow_failure: true
    # - &shotgun_rule_tag
    #   if: '$CI_PROJECT_NAMESPACE == "isc-private" && $CI_COMMIT_TAG != null'
    #   variables:
    #     SHOTGUN_ROUNDS: 3
    # - &shotgun_rule_other
    #   if: '$CI_PIPELINE_SOURCE =~ /^(api|pipeline|schedule|trigger|web)$/ && $REBASE_ONLY != "1"'
  # when using data from a single run, the overall instability of the results
  # causes quite high false positive rate, rerun the test to attemp to reduce those
  retry: 1
  script:
    - if [ -z "$BASELINE" ]; then export BASELINE=$BIND_BASELINE_VERSION; fi  # this dotenv variable can't be set in the rules section, because rules are evaluated before any jobs run
    - PIPELINE_ID=$(curl -s -X POST --fail
        -F "token=$CI_JOB_TOKEN"
        -F ref=main
        -F "variables[SHOTGUN_TEST_VERSION]=['$CI_COMMIT_REF_NAME', '$BASELINE']"
        -F "variables[SHOTGUN_DURATION]=300"
        -F "variables[SHOTGUN_ROUNDS]=$SHOTGUN_ROUNDS"
        -F "variables[SHOTGUN_TRAFFIC_MULTIPLIER]=$SHOTGUN_TRAFFIC_MULTIPLIER"
        -F "variables[SHOTGUN_SCENARIO]=$SHOTGUN_SCENARIO"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_CPU_MIN]=$SHOTGUN_EVAL_THRESHOLD_CPU_MIN"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_CPU_MAX]=$SHOTGUN_EVAL_THRESHOLD_CPU_MAX"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_MEMORY_MIN]=$SHOTGUN_EVAL_THRESHOLD_MEMORY_MIN"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_MEMORY_MAX]=$SHOTGUN_EVAL_THRESHOLD_MEMORY_MAX"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_RCODE_MIN]=$SHOTGUN_EVAL_THRESHOLD_RCODE_MIN"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_RCODE_MAX]=$SHOTGUN_EVAL_THRESHOLD_RCODE_MAX"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_MIN]=$SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_MIN"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_MAX]=$SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_MAX"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_DRIFT_MIN]=$SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_DRIFT_MIN"
        -F "variables[SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_DRIFT_MAX]=$SHOTGUN_EVAL_THRESHOLD_LATENCY_PCTL_DRIFT_MAX"
        https://gitlab.isc.org/api/v4/projects/188/trigger/pipeline | jq .id)
    - util/ci-wait-shotgun.py $PIPELINE_ID
  needs:
    - job: ci-variables
      artifacts: true
  timeout: 2h

.system_test_common: &system_test_job
  <<: *default_triggering_rules
  stage: system
  # This script needs to: 1) fail if the system tests fail, 2) fail if
  # the junit.xml file is broken, 3) produce the junit.xml file even if
  # the system tests fail.  Therefore, $RET is used to "cache" the
  # result of running pytest as interrupting the script immediately when
  # system tests fail would make checking the contents of the junit.xml
  # file impossible (GitLab Runner uses "set -o pipefail").
  script:
    - *setup_interfaces
    - *fips_feature_test
    - *find_pytest
    - *find_python
    - ( if [ "${CI_DISPOSABLE_ENVIRONMENT}" = "true" ]; then sleep 3000; "$PYTHON" "${CI_PROJECT_DIR}/util/get-running-system-tests.py"; fi ) &
    - cd bin/tests/system
    - RET=0
    - >
      (python3.12 -m pytest --assert=plain --junit-xml="$CI_PROJECT_DIR"/junit.xml -n "$TEST_PARALLEL_JOBS" | tee pytest.out.txt) || RET=1
    - *check_for_junit_xml
    - (exit $RET)
    - '( ! grep -F "grep: warning:" pytest.out.txt )'
    - test "$CLEAN_BUILD_ARTIFACTS_ON_SUCCESS" -eq 0 || ( cd ../../.. && ninja -C build clean >/dev/null 2>&1 )
  after_script:
    - *display_pytest_failures
  artifacts:
    untracked: true
    exclude:
      - "**/__pycache__/**/*"
    when: always
    reports:
      junit: junit.xml

.system_test_tsan: &system_test_tsan_job
  <<: *system_test_job
  after_script:
    - *display_pytest_failures
    - *parse_tsan

gcc:almalinux9:amd64:
  variables:
    CC: gcc
    CFLAGS: "${CFLAGS_COMMON}"
    EXTRA_CONFIGURE: "-Didn=enabled -Ddeveloper=disabled"
  <<: *almalinux_9_amd64_image
  <<: *build_job

system:gcc:almalinux9:amd64:
  <<: *almalinux_9_amd64_image
  <<: *system_test_job
  before_script:
    - python3.12 -m pip install dnspython jinja2 pytest==6.2.2 flaky==3.7.0 hypothesis==6.39.1 pytest-timeout==1.4.2 pytest-xdist==2.5.0 pytest-forked==1.4.0 requests
    - echo "/usr/bin/python3.12" > build/bin/tests/system/isctest/vars/.build_vars/PYTHON
  needs:
    - job: gcc:almalinux9:amd64
      artifacts: true
